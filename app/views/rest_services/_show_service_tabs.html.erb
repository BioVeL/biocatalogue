<%
  
  # BioCatalogue: app/views/rest_services/_show_service_tabs.html.erb
  #
  # Copyright (c) 2009, University of Manchester, The European Bioinformatics 
  # Institute (EMBL-EBI) and the University of Southampton.
  # See license.txt for details
  
  %>

<% 
# This tab uses the same stylesheet elements as the operations tab for SOAP services.
%>

<% resources = service_version_instance.rest_resources.sort {|a,b| a.path.downcase <=> b.path.downcase} %>

<% s_d = service_version_instance.service_deployments.first-%>
<% base_url = s_d.endpoint.to_s.sub(/\/$/, '') -%>
<% endpoint_count = 0 %>

<div id="tab-endpoints" class="tabbertab">
  <% resources.each { |res| endpoint_count += res.rest_methods.size } %>
  <h3>Endpoints (<%= endpoint_count -%>)</h3>

  <a name='operations_index'></a>

  <%= add_endpoints_by_popup(service_version_instance, :style => "font-size: 108%;") %>
    
  <div style="padding: 1em 0.6em; border: 1px solid #CCC; line-height: 1.5; background-color: #F3F3F3; font-weight: bold; font-size: 108%; margin-right: 190px;">
    <% resources.each do |resource| %>
      <% resource.rest_methods.each do |meth| %>
        <span style="margin: 0 0.4em;">
          <%= content_tag(:a, h("#{meth.method_type} #{resource_path_to_string(resource.path)}"), 
              :href => "#rest_method_#{meth.id}") -%>
        </span>
      <% end %>
    <% end %>
  </div>

  <div style="margin: 0 1em;">
    
    <% resources.each do |resource| %>
      <% resource.rest_methods.each do |method| %>
      
        <div class="operation_box">
          
          <a id='<%=h "rest_method_#{method.id}" -%>' 
              name='<%=h "rest_method_#{method.id}" -%>'></a>
          
          <p class="operation_heading">
            <b>Endpoint:</b>
            <% endpoint = method.method_type + ' ' + resource_path_to_string(resource.path) %>
            <span class="operation_name"><%= h endpoint -%></span>            
                            
            <span style="font-size:80%; margin-left:10px;">
              ( 
              <% if resource_path_to_string(resource.path) == '/{parameters}' %>
                <%= h"#{base_url}?{parameters}" -%>
              <% elsif resource_path_to_string(resource.path) == '/{id}' %>
                <%= h"#{base_url}/{id}?{any-other-parameters}" -%>
              <% else %>
                <%= h"#{base_url + resource_path_to_string(resource.path)}" -%> 
              <% end %>
              ) 
            </span>
                        
            <span class="method_param_link_container">
              <%= link_to "Delete", rest_method_url(method, :endpoint => endpoint),
                  :confirm => "Are you you want to delete this endpoint.  This cannot be undone.", 
                  :method => :delete,
                  :class => "method_param_delete_link" if BioCatalogue::Auth.allow_user_to_curate_thing?(current_user, method) %>
            </span>
          </p>
          
          <div>
            <div style="float: left; width: 73%;">
              <div style="margin-top: 0.3em; margin-bottom: 2em;">
                <%= render :partial => "annotations/name_aliases",
                  :locals => { :annotatable => method } -%>
              </div>
              
              <div>
                <%= render :partial => "annotations/descriptions",
                  :locals => { :annotatable => method } -%>
              </div>
              
              <div>
                <%= render :partial => "annotations/example_endpoints",
                  :locals => { :annotatable => method } -%>
              </div>
              
              <div>
                <%= render :partial => "annotations/other_annotations",
                  :locals => { :annotatable => method } -%>
              </div>
              
            </div>
              
            <div style="float: right; width: 24%; font-size: 85%;">
              <%= render :partial => "annotations/tags_box",
                :locals => { :annotatable => method } -%>
            </div>
              
            <span class="clear"></span>
          </div>
          
          <br />
          <%= render :partial => "rest_parameters/input_parameters", 
                     :locals => {:method => method, :resource => resource, :endpoint => endpoint} -%>
                  
          <br />
          <%= render :partial => "rest_representations/input_representations", 
                     :locals => {:method => method, :resource => resource} -%>

          <br />
          <%= render :partial => "rest_representations/output_representations", 
                     :locals => {:method => method, :resource => resource} -%>

        </div>
      
      <p style="margin: 0 0 1.5em 0; font-size: 93%; text-align: right;">
        <a href="#operations_index">Back to top</a>
      </p>
      
      <% end %>      
    <% end %>
    
  </div>
  
</div>
