<%

# BioCatalogue: app/views/stats/index.html.erb
#
# Copyright (c) 2009, University of Manchester, The European Bioinformatics 
# Institute (EMBL-EBI) and the University of Southampton.
# See license.txt for details

%>

<% t "All Statistics" %>

<h1>Statistics</h1>

<% if @stats.nil? %>

	<p style="font-weight: bold;">
		Stats are being generated...
	</p>
	
	<p>
		This page will automatically refresh every 60 seconds until the stats data is available.
		<br/>
		<small class="faded">JavaScript needs to be enabled for the auto refresh to work.</small>
	</p>
	
	<script language="JavaScript"> 
		// CREDITS: 
		// Automatic Page Refresher by Peter Gehrig and Urs Dudli www.24fun.com 
		// Permission given to use the script provided that this notice remains as is. 
		// Additional scripts can be found at http://www.hypergurl.com 
		// Configure refresh interval (in seconds) var refreshinterval=5 
		// Shall the coundown be displayed inside your status bar? Say "yes" or "no" below: var displaycountdown="yes"
		var displaycountdown="yes"
		// Do not edit the code below 
		var starttime;
		var nowtime; 
		var reloadseconds=0; 
		var secondssinceloaded=0; 
		function starttime() { 
			starttime=new Date();
			starttime=starttime.getTime();
			countdown(); 
		} 
		function countdown() { 
			nowtime= new Date();
			nowtime=nowtime.getTime();
			secondssinceloaded=(nowtime-starttime)/1000;
			reloadseconds=Math.round(refreshinterval-secondssinceloaded);
			if (refreshinterval>=secondssinceloaded) { 
				var timer=setTimeout("countdown()",1000) 
				if (displaycountdown=="yes") { 
					window.status="Page refreshing in "+reloadseconds+ " seconds";
				} 
			} else { 
				clearTimeout(timer); 
				window.location.reload(true);
			} 
		} 
		window.onload=starttime;
	</script>

<% else %>

	<p>
		<b>Last calculated:</b> <%= @stats.created_at.to_s -%>
		<%= link_to(refresh_image + " Refresh", refresh_stats_path, :class => "button_slim", :method => :post, :style => "margin-left: 3em;") -%>
	</p>

	<div id="stats_page">
		
		<!-- Left column -->
		<div class="left_column">
		
			<% benchmark "Statistics - General" do %>
			
				<a name="general"></a>
			
				<h4 style="margin-top: 0.5em">General</h4>
				
				<table class="biocat_table">
					<tr>
						<th></th>
						<th>Total:</th>
						<th>Last 7 days:</th>
						<th>Last 30 days:</th>
						<th>Last 90 days:</th>
						<th>Last 180 days:</th>
					</tr>
					
					<% BioCatalogue::Stats::MODELS.each do |m| %>
						<tr>
							<td>
								<b><%= m.name.titleize.pluralize -%></b>
							</td>
							<td class="value center">
								<%= number_with_delimiter(@stats.total_for_model(m)) -%>
							</td>
							<td class="value center">
								<%= number_with_delimiter(@stats.total_for_model(m, :last_7)) -%>
							</td>
							<td class="value center">
								<%= number_with_delimiter(@stats.total_for_model(m, :last_30)) -%>
							</td>
							<td class="value center">
								<%= number_with_delimiter(@stats.total_for_model(m, :last_90)) -%>
							</td>
							<td class="value center">
								<%= number_with_delimiter(@stats.total_for_model(m, :last_180)) -%>
							</td>
						</tr>
					<% end %>
				</table>
				
				<br/>
					
				<p class="box_info_standout">
					NOTE: the Annotations count above is only for the metadata stored within the generic Annotations mechanism and 
					does not include metadata from service description docs (like from WSDLs for SOAP services). To see all metadata counts go to the 
					<a href="#metadata">Metadata</a> section.
				</p>
			
			<% end %>
			
			<br/>
			
			<% benchmark "Statistics - Metadata" do %>
			
				<a name="metadata"></a>
				
				<h4>Metadata *</h4>
				
				<p class="box_info_standout">
					<b>*</b> These include all the annotations stored via the generic Annotations mechanism AND 
					metadata from service description docs (like from WSDLs for SOAP services).
				</p>
				
				<br/>
				
				<table class="biocat_table">
					<tr>
						<th></th>
						<th>Total on services:</th>
						<th>Average per service:</th>
						<th>Max no. on services:</th>
						<th>Min no. on services:</th>
					</tr>
					
					<% BioCatalogue::Annotations.metadata_sources.concat([ :all ]).each do |type| %>
						<%= render :partial => 'metadata_stats_for_type', :locals => { :type => type } -%>
					<% end %>
				</table>
				
			<% end %>
			
			<br/>
			
			<% benchmark "Statistics - Search" do %>
			
				<a name="search"></a>
			
				<h4>Search</h4>
				
				<p>
					<b>Total:</b>
					<%= @stats.total_searches_non_unique -%>
				</p>
				
				<p>
					<b>Total unique queries:</b>
					<%= @stats.total_searches_unique -%>
				</p>
				
				<p>
					<b>Queries Breakdown:</b>
				
					<% if @stats.search_queries_with_frequencies_sorted_descending.length > 10 %>
						<span style="padding-left: 2em;">
							<%= render_show_hide_more_search_queries_links -%>
						</span>
					<% end %>
				</p>
				
				<table class="biocat_table">
					<tr>
						<th>Query:</th>
						<th>Frequency:</th>
					</tr>
					
					<% search_queries_count = 0 %>
					<% @stats.search_queries_with_frequencies_sorted_descending.each do |query, frequency| %>
						<% 
							search_queries_count += 1
							row_class = (search_queries_count > 10 ? "search_query_hidden" : "")
							show_row = row_class.blank?
						%>
						<tr class="<%= row_class -%>" style="<%= show_row ? "" : "display: none;" -%>">
							<td><%= h(query) -%></td>
							<td class="value center"><%= frequency -%></td>
						</tr>
					<% end %>
				</table>
					
			<% end %>
			
		</div>
		
		<!-- Right column -->
		<div class="right_column">
			
			<div class="box_info" style="position: fixed;">
				<ul class="contents">
					<li><a href="#general">General</a></li>
					<li>
						<a href="#metadata">Metadata</a>
						<br/>
						<ul>
							<% BioCatalogue::Annotations.metadata_sources.each do |type| %>
								<li><a href="#metadata_<%= type.to_s -%>">By <%= type.to_s.titleize -%></a></li>
							<% end %>
							<li><a href="#metadata_all">By ALL metadata sources</a></li>
						</ul>
					</li>
					<li><a href="#search">Search</a></li>
				</ul>
			</div>
		</div>
		
		<span class="clear"></span>
		
	</div>

<% end %>

