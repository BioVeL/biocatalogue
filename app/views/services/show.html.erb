<%

# BioCatalogue: app/views/services/show.html.erb
#
# Copyright (c) 2009, University of Manchester, The European Bioinformatics 
# Institute (EMBL-EBI) and the University of Southampton.
# See license.txt for details

%>

<% t "#{h @service.name} (#{@service.service_types.to_sentence}) [Provided by: #{h(@service.providers.map{|p| p.name}.to_sentence)}]" -%>


<table style="width: 100%;">
	<tr>
		<td>
			
			<h1 style="margin-top: 0.2em;">
				Service: 
				<span class="orange_highlight"><%= h @service.name -%></span>
				<%= service_type_badges(@service.service_types) -%>
				<%= service_location_flags(@service) -%>
			</h1>
			
			<div style="margin-top: 0.7em">
				<%= render :partial => "annotations/name_aliases",
									 :locals => { :annotatable => @service,
																:name_annotations => all_name_annotations_for_service(@service) } -%>
			</div>
				
			<div style="margin-top: 1em; margin-bottom: 0.3em;">
				<%= render :partial => "annotations/categories", 
									 :locals => { :service => @service } -%>
			</div>
		
		</td>
		<td style="text-align: right; width: 315px;">
			<div style="text-align: right;">
				<table style="width: 315px; margin-bottom: 1em;">
					<tr>
						<td style="text-align: right; vertical-align: middle; padding-right: 30px; width: 130px;">
							<%= render :partial => 'services/stats_bar', :locals => { :service => @service } -%>
						</td>
						<td style="text-align: right; padding-right: 25px; width: 50px;">
							<%= service_latest_status_symbol(@service) -%>
						</td>
						
						<td style="text-align: right; width: 80px;">
							<%= link_to("permalink", service_url(@service), :style => "font-size: 85%;") -%>
					
							<br/><br/>
							
							<%= link_to "View the comments on this service", 
													service_url(@service, :anchor => "#disqus_thread"),
													:style => "font-size: 85%;" -%>
						</td>
					</tr>
					<tr>
						<td colspan=3 style="text-align: right; padding-top: 1em;">
							<%= render :partial => "services/annotation_counts",
												 :locals => { :service => @service } -%>
						</td>
					</tr>
				</table>
			</div>
		</td>
	</tr>
</table>


<div id="service-tabs" class="tabber" style="margin-top: 2em;">
	
  <div id="tab-overview" class="tabbertab">
    <h3>Overview</h3>
		
		<!-- Left column -->
		<div class="service_properties" style="float: left; width: 67%;">
			<% if false %>
			<p>
			  <b>Unique code:</b>
			  <%=h @service.unique_code %>
			</p>
			<% end %>
			
			<p>
				<b>Provider:</b>
				<br/>
				<% @service.providers.each do |provider| %>
					<%= link_to(h(provider.name), service_provider_path(provider)) %>
					<br/>
				<% end %>
			</p>
		
			<p>
				<b>Location:</b>
				<br/>
				<% @service.service_deployments.each do |s_d| %>
					<% unless (loc = s_d.location).blank? -%>
						<%= h s_d.location -%>
						<%= flag_icon_from_country(s_d.country, :text => loc) -%>
						<br/>
					<% end %>
				<% end %>
			</p>
			
			<p>
				<b>Submitter / Source:</b>
				<br/>
				<%= submitter_link(@service.submitter, "margin-right: 0.5em; vertical-align: middle;") %>
				<span class="ago" style="vertical-align: baseline;">
					(<%= distance_of_time_in_words_to_now(@service.created_at) -%> ago)
				</span>
			</p>
			
			<p>
				<b>Endpoint:</b>
				<br/>
				<% @latest_version.service_deployments.each do |s_d| -%>
					<%= link_to(h(s_d.endpoint), s_d.endpoint, :popup => true) -%>
				<% end %>
			</p>
			
			<%= render :partial => "#{@latest_version_instance.class.to_s.pluralize.underscore}/show_service_overview_metadata", 
				 	 			 :locals => { :service_version_instance => @latest_version_instance } %>
			
			<div class="property">
				<%= render :partial => "annotations/documentation_urls",
									 :locals => { :annotatable => @latest_version_instance } -%>
			</div>
			
			<div class="property">
				<%= render :partial => "annotations/descriptions",
									 :locals => { :annotatable => @latest_version_instance } -%>
			</div>
			
			<div class="property">					 
				<%= render :partial => "annotations/costs",
									 :locals => { :annotatable => @latest_deployment } -%>
			</div>
			
			<div class="property">					 
				<%= render :partial => "annotations/licenses",
									 :locals => { :annotatable => @latest_deployment } -%>
			</div>
			
			<div class="property">					 
				<%= render :partial => "annotations/contacts",
									 :locals => { :annotatable => @service } -%>
			</div>
			
			<% if false %>
			<div class="property">			 
				<%= render :partial => "annotations/other_annotations",
								 	 :locals => { :annotatable => @service } -%>
			</div>
			<% end %>
		</div>
		
		<!-- Right column -->
		<div style="float: right; width: 30%;">
			
			<%= render :partial => "annotations/tags_box",
								 :locals => { :annotatable => @service } -%>
			
			<div id="ratings">
				<%= render :partial => "annotations/ratings_box",
								 	 :locals => { :annotatable => @service,
																:categories_config => BioCatalogue::Annotations.get_ratings_categories_config_for_model("Service") } -%>
			</div>
			
			<%= render :partial => "favourited_box" -%>
			
			<%= render :partial => "similar_services_box" -%>
		</div>
		
		<span class="clear"></span>
  </div>
  
	
	<%= render :partial => "#{@latest_version_instance.class.to_s.pluralize.underscore}/show_service_tabs", 
					 	 :locals => { :service_version_instance =>  @latest_version_instance } %>

	
  <div id="tab-monitoring" class="tabbertab">
    <h3>Monitoring</h3>
		
		<%= service_latest_status_symbol(@service) -%>  <br/>
		
		<h4>Availability Checks</h4> 
		<hr/>
		
		<div id="tab-monitoring" class="tabbertab">
		  <% @service.service_deployments.each  do |dep|  -%>
			<table>
				<tr>
					<td><%= service_test_status_symbol(dep.latest_endpoint_status, "Endpoint")%> </td>
					<td> <%= link_to(h("Service Endpoint"),  dep.endpoint, :popup => true) -%> <p/> <%= service_test_status_message(dep.latest_endpoint_status) -%></td>		
				</tr>
			</table>
			<p>
		    Recent History
			</p>
			<p>
				<ul>
			    	<% dep.endpoint_recent_history.each  do |hist| %>
						<% unless hist.result == -1  %>
							<li><%= service_test_status_symbol(hist,"Endpoint", true) %> 
					    		<%= distance_of_time_in_words_to_now(hist.created_at) -%> ago
							</li>
						<%end%>
				  	<%end%>
				</ul>
			</p>
			
		  <%end%>
		</div>
		
		<p>
		<% @service.service_version_instances_by_type('soap').each  do |soap|  %>
			<table>
				<tr>
		 			<td><%= service_test_status_symbol(soap.latest_wsdl_location_status, "Wsdl Location")%> </td>
					<td><%= link_to(h("Wsdl Location"), soap.wsdl_location, :popup => true) -%> <p> <%= service_test_status_message(soap.latest_wsdl_location_status) -%> </p></td>
				</tr>
			</table>
			<p>
		    	Recent History
			</p>
			<p>
				<ul>
				<% soap.wsdl_location_recent_history.each  do |hist| %>
					<% unless hist.result == -1  %>
						<li><%= service_test_status_symbol(hist,"Wsdl Location", true)  %> 
					    	<%= distance_of_time_in_words_to_now(hist.created_at) -%> ago
						</li>
					<%end%>
				<%end%>
				</ul>
			<p>
			
		<%end%>
		<p/>
		<hr/>
	    
		
		<% if false %>
	
		<h4>Tests for this Service</h4>
	 
		<% if @service.service_tests.empty? -%>  <br/>
		  None <br/>
		<% else -%>
			<% @service.service_tests.each do |test| -%>  <br/>
				<%= test.name -%>  <br/>
			<% end %>
		<% end -%>
	
	
	 	<% if mine?(@service) -%>
			<div id='tests' style="margin-top: 2em; border-top: 2px solid #CCF; padding-top: 1em;">
				<%= render :partial => 'shared/service_test', :locals => {:service_tests => @service} -%>
			</div>
		<% end %>
		<% end %>
	</div>
 
</div>

<%= render :partial => 'shared/tabber_startup' -%>

<div style="margin-top: 2em; border-top: 2px solid #CCF; padding-top: 1em;">
	<h2>Comments</h2>
	
	<a name="comments"><%= disqus_comment_counts -%></a>
	
	<%= disqus_thread -%>
</div>
